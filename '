{-# LANGUAGE DeriveGeneric #-}
{-# LANGUAGE RecordWildCards #-}
{-# LANGUAGE OverloadedStrings #-}

module Main where

import System.Environment
import Network.HTTP.Dispatch.Core
import Network.HTTP.Dispatch.Types
import Data.ByteString.Lazy as BL
import Data.Text
import qualified Data.Text as T
import GHC.Generics
import Data.Aeson

appKey :: IO Text
appKey = T.pack <$> getEnv "BUGSNAG_APP_KEY"

data BugsnagEvent = BugsnagEvent
  { exceptions :: [BugsnagException]
  } deriving (Show, Eq, Generic)

data BugsnagThread = BugsnagThread
  deriving (Show, Eq, Generic)

data BugsnagStackFrame = BugsnagStackFrame
  { file :: Text
  , method :: Text
  , lineNumber :: Int
  , columnNumber :: Maybe Int
  , inProject :: Bool
  } deriving (Show, Eq, Generic)

instance ToJSON BugsnagStackFrame

data BugsnagException = BugsnagException
  { errorClass :: Text
  , message :: Text
  , stacktrace :: [BugsnagStackFrame]
  } deriving (Show, Eq, Generic)

data BugsnagUser = BugsnagUser
  { id :: Maybe Text
  , name :: Maybe Text
  , email :: Maybe Text
  } deriving (Show, Eq, Generic)

data BugsnagApp  = BugsnagApp
  { version :: Maybe Text
  , releaseStage :: Maybe Text
  } deriving (Show, Eq, Generic)

data BugsnagDevice = BugsnagDevice
  { osVersion :: Maybe Text
  , hostname :: Maybe Text
  } deriving (Show, Eq, Generic)

data BugsnagMetaData = BugsnagMetaData
  deriving (Show, Eq, Generic)

instance ToJSON BugsnagEvent where
  toJSON BugsnagEvent{..} = object
    [ "payloadVersion" .= text "2"
    , "exceptions" .= toJSON exceptions
    ]
instance ToJSON BugsnagThread
instance ToJSON BugsnagException
instance ToJSON BugsnagUser
instance ToJSON BugsnagApp
instance ToJSON BugsnagDevice
instance ToJSON BugsnagMetaData where
  toJSON _ = object [] -- ^ TODO

data BugsnagRequest = BugsnagRequest
  { apiKey :: Text 
  , events :: [BugsnagEvent]
  , threads :: Maybe [BugsnagThread]
  , context :: Maybe Text
  , groupingHash :: Maybe Text
  , user :: BugsnagUser
  , app :: BugsnagApp
  , device :: BugsnagDevice
  , metaData :: Maybe BugsnagMetaData
  } deriving (Show, Eq, Generic)

text :: Text -> Text
text t = t

instance ToJSON BugsnagRequest where
  toJSON BugsnagRequest{..} =
    object
      [ "apiKey" .= apiKey
      , "notifier" .= object
        [ "name" .= text "Haskell Notifier"
        , "version" .= text "1.0.1.1"
        , "url" .= text "https://github.com/5outh/bugsnag-haskell"
        ]
      , "events" .= toJSON events
      , "threads" .= toJSON threads
      , "context" .= toJSON context
      , "groupingHash" .= toJSON groupingHash
      , "user" .= toJSON user
      , "app" .= toJSON app
      , "device" .= toJSON device
      , "metaData" .= toJSON metaData
      ]

myReq key = BugsnagRequest
  key
  [
    BugsnagEvent
      [ (BugsnagException "ErrorClass" "There was an error" [BugsnagStackFrame "Main.hs" "myReq" 88 (Just 0) True]) ]
      ]
  (Just [])
  (Just "context")
  (Just "groupingHash")
  (BugsnagUser (Just "10")  (Just "Ben") (Just "ben@ben.co"))
  (BugsnagApp (Just "1.0") (Just "production"))
  (BugsnagDevice (Just "2.1.1") (Just "web1.internal"))
  (Just BugsnagMetaData)

myHttpReq :: Text -> HTTPRequest
myHttpReq key = HTTPRequest
  POST
  "https://notify.bugsnag.com" 
  [header "Content-Type" "application/json"]
  (Just (BL.toStrict (encode $ myReq key)))

main :: IO ()
main = do
  key <- appKey
  runRequest (myHttpReq key)
  return ()
